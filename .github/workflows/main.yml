name: KMM Bridge Publish Release
on: workflow_dispatch

jobs:
  call-kmmbridge-publish:
  steps:
    - name: Checkout the repo
      uses: actions/checkout@v3

    - name: Apply SSH Key
      if: ${{ env.PODSPEC_SSH_KEY_EXISTS == 'true' }}
      uses: webfactory/ssh-agent@v0.5.4
      with:
        ssh-private-key: ${{ secrets.PODSPEC_SSH_KEY }}
    - uses: extractions/netrc@v1
      with:
        machine: touchlabtest.jfrog.io
        username: ${{ secrets.ARTIFACTORY_USERNAME }}
        password: ${{ secrets.ARTIFACTORY_PASSWORD }}
  #  - uses: extractions/netrc@v1
  #    with:
  #      machine: api.github.com
  #      username: "cirunner"
  #      password: ${{ secrets.GITHUB_TOKEN }}

  #  - uses: extractions/netrc@v1
  #    with:
  #      machine: maven.pkg.github.com
  #      username: "cirunner"
  #      password: ${{ secrets.GITHUB_TOKEN }}

    - uses: actions/setup-java@v2
      with:
        distribution: "adopt"
        java-version: "11"

    - name: Validate Gradle Wrapper
      uses: gradle/wrapper-validation-action@v1

    - name: Cache build tooling
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.konan
        key: ${{ runner.os }}-v4-${{ hashFiles('*.gradle.kts') }}

    - name: Build Main
      run: ./gradlew kmmBridgePublish -PGITHUB_REPO=${{ github.repository }} -PUSERNAME=${{ secrets.ARTIFACTORY_USERNAME}} -PPASSWORD=${{ secrets.ARTIFACTORY_PASSWORD }} --no-daemon --stacktrace
      env:
        GRADLE_OPTS: -Dkotlin.incremental=false -Dorg.gradle.jvmargs="-Xmx3g -XX:MaxPermSize=2048m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8 -XX:MaxMetaspaceSize=512m"
